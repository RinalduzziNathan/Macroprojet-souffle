<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Volcan et Micro</title>
    <style>
        .hidden {
            display: none;
        }

        canvas {
            background-color: bisque;
            border: 1px solid black;
        }

        .couleurBouton{
            
            box-shadow: inset 0px 4px 15px 3px #6094e8;
            background: linear-gradient(to bottom, #2e466e 5%, #415989 100%);
            background-color: #2e466e;
            border-radius: 17px;
            border: 1px solid #1f2f47;
            display: inline-block;
            cursor: pointer;
            color: #ffffff;
            font-family: Courier New;
            font-size: 21px;
            padding: 12px 52px;
            text-decoration: none;
        }
        
        .couleurBouton:hover {
            background: linear-gradient(to bottom, #415989 5%, #2e466e 100%);
            background-color: #415989;
        }

        .couleurBouton:active {
            position: relative;
            top: 1px;
        }

        .timer {
            margin-top: 20px;
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }
    </style>
    <script src="https://unpkg.com/@dotlottie/player-component@2.7.12/dist/dotlottie-player.mjs" type="module"></script>

</head>

<body>
    <p>Intensité du souffle : <span id="intensityText">0</span></p>
    <button id="couleurBouton" class="couleurBouton">START</button>
    <div id="timer">Temps restant : 5s</div>
    <canvas id="myCanvas" width="800" height="400"></canvas>
    <canvas id="volcanoCanvas" width="400" height="400"></canvas>
    <dotlottie-player id="base" src="https://lottie.host/bfc76ed8-a603-4705-b1ba-529d3c77dba2/FXRxowFxXs.lottie"
        background="transparent" speed="1" autoplay loop class="hidden" style="width: 1100px; height: 700px">
    </dotlottie-player>
    <script>
        const couleurBouton = document.getElementById("couleurBouton");
        
        const canvasGraph = document.getElementById("myCanvas");
        const ctxGraph = canvasGraph.getContext('2d');

        couleurBouton.addEventListener("click", function () {

            canvasGraph.style.backgroundColor = "red";
            console.log("Couleur du fond changée en: " + "red")
        });

        const timerDisplay = document.getElementById("timer");

        var remplirTableau = false
        var finTableau = false

        // Fonction pour démarrer le timer de 5 secondes
        function startTimer() {
            let timeLeft = 5;  // Démarre avec 5 secondes
            remplirTableau = true
            // Afficher le temps restant dans le div
            const intervalId = setInterval(() => {
                timerDisplay.textContent = `Temps restant : ${timeLeft}s`;
                timeLeft--;

                // Si le temps est écoulé, arrêter l'intervalle et afficher un message
                if (timeLeft < 0) {
                    canvasGraph.style.backgroundColor = "purple";
                    clearInterval(intervalId);
                    timerDisplay.textContent = "Temps écoulé";
                    console.log("Le timer de 5 secondes est terminé!");
                    remplirTableau = false
                    finTableau = true
                }
            }, 1000);  // Met à jour toutes les secondes (1000ms)
        }

        // Écouter le clic du bouton pour démarrer le timer
        couleurBouton.addEventListener("click", function() {
            // Démarrer le timer de 5 secondes
            startTimer();
        });

        const canvas = document.getElementById("volcanoCanvas");
        const ctx = canvas.getContext("2d");
        const intensityText = document.getElementById("intensityText");
        var baseVolcano = document.getElementById("base");
        baseVolcano.classList.remove("hidden");
        baseVolcano.speed = 1;
        // baseVolcano.src = "https://lottie.host/cc1dc667-d3fb-425f-9230-223e31070f2e/65CBkiaq4d.lottie"
        //effusifVolcano.classList.toggle("hidden");
        navigator.mediaDevices.getUserMedia({ audio: true })
            .then(stream => {
                const audioContext = new AudioContext();
                const analyser = audioContext.createAnalyser();
                const mic = audioContext.createMediaStreamSource(stream);
                mic.connect(analyser);
                analyser.fftSize = 256;
                const dataArray = new Uint8Array(analyser.frequencyBinCount);
                var intensityArray = []
                function draw() {
                    requestAnimationFrame(draw);
                    analyser.getByteFrequencyData(dataArray);
                    let volume = dataArray.reduce((a, b) => a + b) / dataArray.length;
                    let intensity = Math.min(volume / 2, 100); // Normalisation du volume

                    if(remplirTableau == true){
                        let addIntensity = intensityArray.push(intensity)   
                    }


                    intensityText.textContent = intensity.toFixed(2);
                    ctx.clearRect(0, 0, canvas.width, canvas.height);

                    //
                    // Choix de la couleur de la barre d'intensité
                    let barColor = "green";
                    if (intensity > 10) barColor = "blue";
                    if (intensity > 20) barColor = "yellow";
                    if (intensity > 35) barColor = "orange";
                    if (intensity > 70) barColor = "red";

                    ctx.clearRect(0, 0, canvas.width, canvas.height);

                    // Dessin du volcan
                    ctx.fillStyle = "brown";
                    ctx.beginPath();
                    ctx.moveTo(150, 300);
                    ctx.lineTo(250, 300);
                    ctx.lineTo(200, 200);
                    ctx.closePath();
                    ctx.fill();



                    // Dessin de la boule rouge en haut du triangle en fonction de l'intensité (boule)
                    if (intensity > 10) {
                        ctx.fillStyle = "red";
                        ctx.beginPath();
                        ctx.arc(200, 190, intensity / 2, 0, Math.PI * 2);
                        ctx.fill();
                    }
                    //couleur dynamique
                    ctx.fillStyle = barColor;
                    ctx.fillRect(50, 300 - intensity * 2, 20, intensity * 2);

                    if (finTableau == true) {
                        var finalArray = intensityArray;

                    
                        console.log(finalArray + " c final array de taille " + finalArray.length)

                        //console.log(finalArray)
                        function movingAverage(array, windowSize) {
                            let smoothedArray = [];
                            for (let i = 0; i < array.length; i++) {
                                let start = Math.max(0, i - Math.floor(windowSize / 2));
                                let end = Math.min(array.length, i + Math.floor(windowSize / 2) + 1);
                                let sum = 0;
                                for (let j = start; j < end; j++) {
                                    sum += array[j];
                                }
                                smoothedArray.push(sum / (end - start));
                            }
                            return smoothedArray;
                        }

                        function linearRegressionTrend(array) {
                            let n = array.length;
                            let sumX = 0, sumY = 0, sumXY = 0, sumXX = 0;

                            for (let i = 0; i < n; i++) {
                                sumX += i;
                                sumY += array[i];
                                sumXY += i * array[i];
                                sumXX += i * i;
                            }

                            let slope = (n * sumXY - sumX * sumY) / (n * sumXX - sumX * sumX);
                            return slope; // Si > 0, tendance à la hausse
                        }

                        // Utilisation :
                        let windowSize = 10; // Ajuste la taille du lissage selon ton besoin
                        let smoothedArray = movingAverage(finalArray, windowSize);
                        let trend = linearRegressionTrend(smoothedArray);

                        console.log("Tendance (pente de régression) :", trend);
                        console.log(trend > 0.09 ? "L'intensité augmente globalement." : "Pas d'augmentation claire.");

                        if (trend > 0.09) {
                            baseVolcano.load("https://lottie.host/1a3a4376-3629-4e3e-aeb2-fcc2d5d49e35/FBCgmw7yBd.lottie")
                        }
                        if (trend < 0.09 && trend > -0.09) {
                            baseVolcano.load("https://lottie.host/cc1dc667-d3fb-425f-9230-223e31070f2e/65CBkiaq4d.lottie")
                        }
                        // Création du graphique
                        const canvasGraph = document.getElementById('myCanvas');
                        const ctxGraph = canvasGraph.getContext('2d');
                        ctxGraph.fillText(Math.max(...smoothedArray).toFixed(2), 10, 50);

                        // Dessiner l'axe X
                        ctxGraph.beginPath();
                        ctxGraph.moveTo(50, 350);
                        ctxGraph.lineTo(750, 350);
                        ctxGraph.stroke();

                        // Dessiner l'axe Y
                        ctxGraph.beginPath();
                        ctxGraph.moveTo(50, 350);
                        ctxGraph.lineTo(50, 50);
                        ctxGraph.stroke();

                        // Définir l'échelle
                        const maxVal = Math.max(...smoothedArray);
                        const minVal = Math.min(...smoothedArray);
                        const scaleX = (canvasGraph.width - 100) / smoothedArray.length;
                        const scaleY = (canvasGraph.height - 100) / (maxVal - minVal);

                        // Dessiner la courbe
                        ctxGraph.beginPath();
                        ctxGraph.moveTo(50, canvasGraph.height - (smoothedArray[0] - minVal) * scaleY - 50);
                        for (let i = 1; i < smoothedArray.length; i++) {
                            let x = 50 + i * scaleX;
                            let y = canvasGraph.height - (smoothedArray[i] - minVal) * scaleY - 50;
                            ctxGraph.lineTo(x, y);
                        }
                        ctxGraph.strokeStyle = 'blue';
                        ctxGraph.stroke();
                        finTableau = false;


                    }
                }

                draw();

            })
            .catch(err => console.error("Micro inaccessible:", err));
    </script>
</body>

</html>