<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Volcan et Micro</title>
    <style>
        .hidden {
            display: none;
        }



        .couleurBouton {

            box-shadow: inset 0px 4px 15px 3px #6094e8;
            background: linear-gradient(to bottom, #2e466e 5%, #415989 100%);
            background-color: #2e466e;
            border-radius: 17px;
            border: 1px solid #1f2f47;
            display: inline-block;
            cursor: pointer;
            color: #ffffff;
            font-family: Courier New;
            font-size: 21px;
            padding: 12px 52px;
            text-decoration: none;
            position: relative;
            /* Assure que le z-index fonctionne */
            z-index: 10;
            /* Met le bouton au-dessus de l'animation */
        }



        .couleurBouton:hover {
            background: linear-gradient(to bottom, #415989 5%, #2e466e 100%);
            background-color: #415989;
        }

        .verticalCenter {
            margin: 0;
            position: absolute;
            left: 45%;
            -ms-transform: translateY(-45%);
            transform: translateY(-45%);
        }

        .center {
            margin: 0;
            position: absolute;
            top: 50%;
            left: 50%;
            -ms-transform: translate(-50%, -50%);
            transform: translate(-50%, -50%);
        }

        .timer {
            margin-top: 20px;
            color: #333;
            font-family: Courier New;
            font-size: 15px;
            position: relative;
            /* Assure que le z-index fonctionne */
            z-index: 10;
            /* Met le bouton au-dessus de l'animation */
        }
    </style>
    <script src="https://unpkg.com/@dotlottie/player-component@2.7.12/dist/dotlottie-player.mjs" type="module"></script>

</head>

<body style="background-color: lightgoldenrodyellow;">

    <button id="couleurBouton" class="couleurBouton center">START</button>
    <div id="timer" class="timer verticalCenter">Temps restant : 5s</div>

    <dotlottie-player id="base" src="https://lottie.host/bfc76ed8-a603-4705-b1ba-529d3c77dba2/FXRxowFxXs.lottie"
        background="transparent" speed="1" autoplay loop class="hidden" style="width: 1400px; height: 700px">
    </dotlottie-player>
    <script>
        const couleurBouton = document.getElementById("couleurBouton");

        const timerDisplay = document.getElementById("timer");

        var remplirTableau = false
        var finTableau = false

        // Fonction pour démarrer le timer de 5 secondes
        function startTimer() {
            let timeLeft = 5;  // Démarre avec 5 secondes
            remplirTableau = true
            // Afficher le temps restant dans le div
            const intervalId = setInterval(() => {
                timerDisplay.textContent = `Temps restant : ${timeLeft}s`;
                timeLeft--;

                // Si le temps est écoulé, arrêter l'intervalle et afficher un message
                if (timeLeft < 0) {

                    clearInterval(intervalId);
                    timerDisplay.textContent = "Temps écoulé";

                    remplirTableau = false
                    finTableau = true
                }
            }, 1000);  // Met à jour toutes les secondes (1000ms)
        }

        // Écouter le clic du bouton pour démarrer le timer
        couleurBouton.addEventListener("click", function () {
            // Démarrer le timer de 5 secondes
            startTimer();
            couleurBouton.style.visibility = "hidden";
        });

        //const intensityText = document.getElementById("intensityText");
        var baseVolcano = document.getElementById("base");
        baseVolcano.classList.remove("hidden");
        baseVolcano.speed = 1;
        // baseVolcano.src = "https://lottie.host/cc1dc667-d3fb-425f-9230-223e31070f2e/65CBkiaq4d.lottie"
        //effusifVolcano.classList.toggle("hidden");
        navigator.mediaDevices.getUserMedia({ audio: true })
            .then(stream => {
                const audioContext = new AudioContext();
                const analyser = audioContext.createAnalyser();
                const mic = audioContext.createMediaStreamSource(stream);
                mic.connect(analyser);
                analyser.fftSize = 256;
                const dataArray = new Uint8Array(analyser.frequencyBinCount);
                var intensityArray = []
                function draw() {
                    requestAnimationFrame(draw);
                    analyser.getByteFrequencyData(dataArray);
                    let volume = dataArray.reduce((a, b) => a + b) / dataArray.length;
                    let intensity = Math.min(volume / 2, 100); // Normalisation du volume

                    if (remplirTableau == true) {
                        let addIntensity = intensityArray.push(intensity)
                    }


                    //intensityText.textContent = intensity.toFixed(2);
                    //ctx.clearRect(0, 0, canvas.width, canvas.height);






                    if (finTableau == true) {
                        var finalArray = intensityArray;


                        console.log(finalArray + " c final array de taille " + finalArray.length)

                        //console.log(finalArray)
                        function movingAverage(array, windowSize) {
                            let smoothedArray = [];
                            for (let i = 0; i < array.length; i++) {
                                let start = Math.max(0, i - Math.floor(windowSize / 2));
                                let end = Math.min(array.length, i + Math.floor(windowSize / 2) + 1);
                                let sum = 0;
                                for (let j = start; j < end; j++) {
                                    sum += array[j];
                                }
                                smoothedArray.push(sum / (end - start));
                            }
                            return smoothedArray;
                        }

                        function linearRegressionTrend(array) {
                            let n = array.length;
                            let sumX = 0, sumY = 0, sumXY = 0, sumXX = 0;

                            for (let i = 0; i < n; i++) {
                                sumX += i;
                                sumY += array[i];
                                sumXY += i * array[i];
                                sumXX += i * i;
                            }

                            let slope = (n * sumXY - sumX * sumY) / (n * sumXX - sumX * sumX);
                            return slope; // Si > 0, tendance à la hausse
                        }

                        // Utilisation :
                        let windowSize = 10; // Ajuste la taille du lissage selon ton besoin
                        let smoothedArray = movingAverage(finalArray, windowSize);
                        let trend = linearRegressionTrend(smoothedArray);

                        console.log("Tendance (pente de régression) :", trend);
                        console.log(trend > 0.09 ? "L'intensité augmente globalement." : "Pas d'augmentation claire.");

                        if (trend > 0.09) {
                            baseVolcano.load("https://lottie.host/1a3a4376-3629-4e3e-aeb2-fcc2d5d49e35/FBCgmw7yBd.lottie")
                        }
                        if (trend < 0.09 && trend > -0.09) {
                            baseVolcano.load("https://lottie.host/cc1dc667-d3fb-425f-9230-223e31070f2e/65CBkiaq4d.lottie")
                        }

                        finTableau = false;


                    }
                }

                draw();

            })
            .catch(err => console.error("Micro inaccessible:", err));
    </script>
</body>

</html>