<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Volcan et Micro</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bricolage+Grotesque:opsz,wght@12..96,700&display=swap" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bricolage+Grotesque:opsz,wght@12..96,300&display=swap" rel="stylesheet">

    <style>
        body {
            background-image: url('interface/cerclevolcan.png'), url('interface/quadrillage.png');
            background-size: 90%, cover;
            background-position: center 20px, center;
            background-repeat: no-repeat;
            height: 100vh;
        }

        .hidden {
            display: none;
        }

        .startBouton {
            
            background-color: white;
            display: inline-block;
            padding: 40px 100px;
            visibility: hidden;
            background-color: white;
            color: rgb(0, 0, 0);
            border: 3px, solid black;
            border-radius: 100px;
            font-family: "Bricolage Grotesque", sans-serif;
            font-optical-sizing: auto;
            font-weight: 700;
            font-style: normal;
            font-variation-settings:"wdth" 100;
            font-size: 90px;
            color: black;
            cursor: pointer;
            z-index: 20;
        }

        .startBouton:hover {
            background-color: red;
        }

        .verticalCenter {
            margin: 0;
            position: absolute;
            left: 48%;
            transform: translateY(-50%);
        }

        .center {
            margin: 0;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .centerTop {
            margin: 0;
            position: absolute;
            top: 25%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .timer {
            margin-top: 70px;
            color: black;
            font-family: "Bricolage Grotesque", sans-serif;
            font-optical-sizing: auto;
            font-weight: 700;
            font-style: normal;
            font-variation-settings:"wdth" 100;
            font-size: 90px;
            color: black;
            z-index: 10;
            
        }

        #clickZoneVentilator {
            position: absolute;
            top: 5px;
            left: 5px;
            width: 150px;
            height: 100px;
            cursor: pointer;
            background-color: rgba(255, 255, 255, 0);
            z-index: 8;
        }

        #expandingCircle {
            position: absolute;
            top: 0px;
            left: 0px;
            width: 250px;
            height: 250px;
            border-radius: 50%;
            background-color: white;
            border: 2.5px solid black;
            z-index: 6;
            transition: all 1s ease;
        }

        #ventilatorImage {
            position: absolute;
            top: 55px;
            left: 75px;
            z-index: 7;
            width: 100px;
            height: 150px;
            rotate: 10deg;
        }

        #volcanImage {
            position: absolute;
            top: 10%;
            left: 22%;
            z-index: 4;
            width: 800px;
            height: 675px;
        }

        /* New Rectangle */
        #soundRectangle {
            position: absolute;
            top: 80%;
            left: 49%;
            transform: translateX(-50%);
            width: 300px;
            background-color: red;
            height: 100px;
            z-index: 3;
            visibility: visible; /* Ensure the rectangle is visible */
            transition: height 0.1s ease-out, top 0.1s ease-out; /* Smooth transition for both height and top */
        }


        /* CSS classes for different heights */
        .height-100 {
            height: 400px;
        }

        .height-150 {
            height: 500px;
        }

        .height-200 {
            height: 700px;
        }

        .height-250 {
            height: 900px;
        }

        .height-300 {
            height: 1000px;
        }

        .height-350 {
            height: 1100px;
        }

        .showButton {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 10px 40px;
            background-color: white;
            color: rgb(0, 0, 0);
            border: 3px, solid black;
            border-radius: 50px;
            font-family: "Bricolage Grotesque", sans-serif;
            font-optical-sizing: auto;
            font-weight: 700;
            font-style: normal;
            font-variation-settings:"wdth" 100;
            font-size: 24px;
            color: black;
            cursor: pointer;
            z-index: 20;
            
        }

        .showButton:hover {
            background-color: red;
        }


    </style>
    <script src="https://unpkg.com/@rive-app/canvas"></script>

</head>

<body>

    <button id="startBouton" class="startBouton centerTop">prêt ?</button>
    <button id="boutonRestart" class="startBouton centerTop">recommencer</button>
    <div id="timer" class="timer verticalCenter"></div>
    <div id="clickZoneVentilator">
        <img id="ventilatorImage" src="interface/ventilateur.png" alt="ventilator" />
        <div id="expandingCircle"></div>
    </div>
    <img id="volcanImage" src="interface/volcanintro.png" alt="volcanintro" />
    <div id="soundRectangle"></div>
    <button id="showAnimationButton" class="showButton"> >>></button>


    <script>

       window.addEventListener('DOMContentLoaded', (event) => {
    const startBouton = document.getElementById("startBouton");
    const boutonRestart = document.getElementById("boutonRestart");
    const timerDisplay = document.getElementById("timer");
    boutonRestart.style.visibility = "hidden";
    var remplirTableau = false;
    var finTableau = false;
    var isBaseAnim = true;
     

    const showAnimationButton = document.getElementById('showAnimationButton');

    showAnimationButton.addEventListener('click', () => {
      //  baseVolcano.classList.remove('hidden'); // Remove the "hidden" class
        // Hide the volcano image
        const volcanImage = document.getElementById('volcanImage');
        volcanImage.style.display = 'none';

        // Hide the sound rectangle
        const soundRectangle = document.getElementById('soundRectangle');
        soundRectangle.style.display = 'none';

        // Show the Start button
        const startBouton = document.getElementById('startBouton');
        startBouton.style.visibility = 'visible';

        
    });


    function startTimer() {
    let timeLeft = 5;
    remplirTableau = true;
    const intervalId = setInterval(() => {
        timerDisplay.textContent = `${timeLeft}`;
        timeLeft--;
        if (timeLeft < 0) {
            timerDisplay.textContent = "";
            clearInterval(intervalId);
            remplirTableau = false;
            finTableau = true;

            // --- ADD THIS ---
           // baseVolcano.load("https://lottie.host/your-effusif-animation.lottie");
            isBaseAnim = false;
        }
    }, 1000);
}


    startBouton.addEventListener("click", function () {
        startTimer();
        startBouton.style.visibility = "hidden";
    });

    boutonRestart.addEventListener("click", function () {
        startTimer();
        boutonRestart.style.visibility = "hidden";
    });

    //var baseVolcano = document.getElementById("base");
    //baseVolcano.classList.remove("hidden");
    //baseVolcano.speed = 1;

    //baseVolcano.addEventListener("loopComplete", (event) => {
      //  if (isBaseAnim == false) {
        //    boutonRestart.style.visibility = "visible";
           // baseVolcano.load("https://lottie.host/bfc76ed8-a603-4705-b1ba-529d3c77dba2/FXRxowFxXs.lottie");
          //  isBaseAnim = true;
        //}
    //});

    navigator.mediaDevices.getUserMedia({ audio: true })
    .then(stream => {
        const audioContext = new AudioContext();
        const analyser = audioContext.createAnalyser();
        const mic = audioContext.createMediaStreamSource(stream);
        mic.connect(analyser);
        analyser.fftSize = 256;
        const dataArray = new Uint8Array(analyser.frequencyBinCount);
        var intensityArray = []

        // Get the rectangle element
        // Get the rectangle element
        const soundRectangle = document.getElementById("soundRectangle");

        // Check if soundRectangle exists
        if (!soundRectangle) {
            console.error("soundRectangle element not found.");
            return;
        }

        // Get initial top position from CSS
        const initialTop = parseInt(window.getComputedStyle(soundRectangle).top, 10);

        function draw() {
            requestAnimationFrame(draw);

            analyser.getByteFrequencyData(dataArray);
            let volume = dataArray.reduce((a, b) => a + b) / dataArray.length;
            let intensity = Math.min(volume / 2, 100); // Normalize volume

            if (intensity !== null && intensity !== undefined && !isNaN(intensity)) {
                let newHeight = 100 + intensity * 4;
                soundRectangle.style.height = `${newHeight}px`;

                let newTop = initialTop - intensity; // Use dynamic initialTop
                soundRectangle.style.top = `${newTop}px`;
            } else {
                console.error("Invalid intensity value:", intensity);
                soundRectangle.style.height = '100px';
                soundRectangle.style.top = `${initialTop}px`;
            }

            if (remplirTableau == true) {
                        let addIntensity = intensityArray.push(intensity)
                    }


                    //intensityText.textContent = intensity.toFixed(2);
                    //ctx.clearRect(0, 0, canvas.width, canvas.height);
             if (finTableau == true) {
                     var finalArray = intensityArray;
                    intensityArray = []


                    console.log(finalArray + " c final array de taille " + finalArray.length)

                        //console.log(finalArray)
                    function movingAverage(array, windowSize) {
                        let smoothedArray = [];
                            for (let i = 0; i < array.length; i++) {
                                let start = Math.max(0, i - Math.floor(windowSize / 2));
                                let end = Math.min(array.length, i + Math.floor(windowSize / 2) + 1);
                                let sum = 0;
                                for (let j = start; j < end; j++) {
                                    sum += array[j];
                                }
                                smoothedArray.push(sum / (end - start));
                            }
                            return smoothedArray;
                        }

                        function linearRegressionTrend(array) {
                            let n = array.length;
                            let sumX = 0, sumY = 0, sumXY = 0, sumXX = 0;

                            for (let i = 0; i < n; i++) {
                                sumX += i;
                                sumY += array[i];
                                sumXY += i * array[i];
                                sumXX += i * i;
                            }

                            let slope = (n * sumXY - sumX * sumY) / (n * sumXX - sumX * sumX);
                            return slope; // Si > 0, tendance à la hausse
                        }

                        // Utilisation :
                        let windowSize = 10; // Ajuste la taille du lissage selon ton besoin
                        let smoothedArray = movingAverage(finalArray, windowSize);
                        let trend = linearRegressionTrend(smoothedArray);

                        console.log("Tendance (pente de régression) :", trend);
                        console.log(trend > 0.09 ? "L'intensité augmente globalement." : "Pas d'augmentation claire.");

                        if (trend > 0.09) {
                         //   isBaseAnim = false
                          //  baseVolcano.load("https://lottie.host/1a3a4376-3629-4e3e-aeb2-fcc2d5d49e35/FBCgmw7yBd.lottie")
                            //baseVolcano.setSpeed(1);
                        }
                        if (trend < 0.09 && trend > -0.09) {
                           // isBaseAnim = false
                            //baseVolcano.load("https://lottie.host/cc1dc667-d3fb-425f-9230-223e31070f2e/65CBkiaq4d.lottie")
                            //baseVolcano.setSpeed(1);


                        }


                        finTableau = false;


        }
    }





        draw(); // Start drawing

    })
    .catch(err => console.error("Microphone access error: ", err));


    const ventilatorImage = document.getElementById('ventilatorImage');
    const expandingCircle = document.getElementById('expandingCircle');

    let isCircleExpanded = false;

    ventilatorImage.addEventListener('click', () => {
        ventilatorImage.style.display = 'none';
        expandingCircle.style.width = '650px';
        expandingCircle.style.height = '650px';
        isCircleExpanded = true;
    });

    expandingCircle.addEventListener('click', () => {
        if (isCircleExpanded) {
            expandingCircle.style.width = '250px';
            expandingCircle.style.height = '250px';
            ventilatorImage.style.display = 'block';
            isCircleExpanded = false;
        }
    });
});

    </script>
</body>

</html>
