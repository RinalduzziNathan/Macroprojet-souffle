<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Volcan et Micro</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bricolage+Grotesque:opsz,wght@12..96,700&display=swap" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bricolage+Grotesque:opsz,wght@12..96,300&display=swap" rel="stylesheet">

    <style>
        body {
            background-image: url('interface/cerclevolcan.png'), url('interface/quadrillage.png');
            background-size: 90%, cover;
            background-position: center 20px, center;
            background-repeat: no-repeat;
            height: 100vh;
        }

        .hidden {
            display: none;
        }

        .startBouton {
            box-shadow: inset 0px 4px 15px 3px #6094e8;
            background: linear-gradient(to bottom, #2e466e 5%, #415989 100%);
            background-color: #2e466e;
            border-radius: 17px;
            border: 1px solid #1f2f47;
            display: inline-block;
            cursor: pointer;
            color: #ffffff;
            font-family: Courier New;
            font-size: 21px;
            padding: 12px 52px;
            text-decoration: none;
            position: relative;
            z-index: 10;
        }

        .startBouton:hover {
            background: linear-gradient(to bottom, #415989 5%, #2e466e 100%);
            background-color: #415989;
        }

        .verticalCenter {
            margin: 0;
            position: absolute;
            left: 45%;
            transform: translateY(-45%);
        }

        .center {
            margin: 0;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .timer {
            margin-top: 20px;
            color: #333;
            font-family: Courier New;
            font-size: 15px;
            position: relative;
            z-index: 10;
        }

        #clickZoneVentilator {
            position: absolute;
            top: 5px;
            left: 5px;
            width: 150px;
            height: 100px;
            cursor: pointer;
            background-color: rgba(255, 255, 255, 0);
            z-index: 10;
        }

        #expandingCircle {
            position: absolute;
            top: 0px;
            left: 0px;
            width: 250px;
            height: 250px;
            border-radius: 50%;
            background-color: white;
            border: 2.5px solid black;
            z-index: 1;
            transition: all 1s ease;
        }

        #ventilatorImage {
            position: absolute;
            top: 55px;
            left: 75px;
            z-index: 10;
            width: 100px;
            height: 150px;
            rotate: 10deg;
        }

        #volcanImage {
            position: absolute;
            top: 10%;
            left: 22%;
            z-index: 10;
            width: 800px;
            height: 675px;
        }

        /* New Rectangle */
        #soundRectangle {
            position: absolute;
            top: 200px;
            left: 50%;
            transform: translateX(-50%);
            width: 300px;
            background-color: red;
            height: 400px;
            z-index: 10;
            visibility: visible; /* Ensure the rectangle is visible */
            transition: height 0.1s ease-out; /* Smooth transition */
        }

        /* CSS classes for different heights */
        .height-100 {
            height: 400px;
        }

        .height-150 {
            height: 500px;
        }

        .height-200 {
            height: 700px;
        }

        .height-250 {
            height: 900px;
        }

        .height-300 {
            height: 1000px;
        }

        .height-350 {
            height: 1100px;
        }

    </style>
    <script src="https://unpkg.com/@dotlottie/player-component@2.7.12/dist/dotlottie-player.mjs" type="module"></script>

</head>

<body>

    <button id="startBouton" class="startBouton center">START</button>
    <button id="boutonRestart" class="startBouton center">RESTART</button>
    <div id="timer" class="timer verticalCenter">Soufflez pendant 5s</div>
    <div id="clickZoneVentilator">
        <img id="ventilatorImage" src="interface/ventilateur.png" alt="ventilator" />
        <div id="expandingCircle"></div>
    </div>
    <img id="volcanImage" src="interface/volcanintro.png" alt="volcanintro" />
    <div id="soundRectangle"></div>


    <dotlottie-player id="base" src="https://lottie.host/bfc76ed8-a603-4705-b1ba-529d3c77dba2/FXRxowFxXs.lottie" background="transparent" speed="1" autoplay loop class="hidden" style="width: 1400px; height: 700px">
    </dotlottie-player>

    <script>
       window.addEventListener('DOMContentLoaded', (event) => {
    const startBouton = document.getElementById("startBouton");
    const boutonRestart = document.getElementById("boutonRestart");
    const timerDisplay = document.getElementById("timer");
    boutonRestart.style.visibility = "hidden";
    var remplirTableau = false;
    var finTableau = false;
    var isBaseAnim = true;

    function startTimer() {
        let timeLeft = 5;
        remplirTableau = true;
        const intervalId = setInterval(() => {
            timerDisplay.textContent = ` Soufflez pendant ${timeLeft}s`;
            timeLeft--;
            if (timeLeft < 0) {
                clearInterval(intervalId);
                timerDisplay.textContent = "Temps écoulé";
                remplirTableau = false;
                finTableau = true;
            }
        }, 1000);
    }

    startBouton.addEventListener("click", function () {
        startTimer();
        startBouton.style.visibility = "hidden";
    });

    boutonRestart.addEventListener("click", function () {
        startTimer();
        boutonRestart.style.visibility = "hidden";
    });

    var baseVolcano = document.getElementById("base");
    baseVolcano.classList.remove("hidden");
    baseVolcano.speed = 1;

    baseVolcano.addEventListener("loopComplete", (event) => {
        if (isBaseAnim == false) {
            boutonRestart.style.visibility = "visible";
            baseVolcano.load("https://lottie.host/bfc76ed8-a603-4705-b1ba-529d3c77dba2/FXRxowFxXs.lottie");
            isBaseAnim = true;
        }
    });

    navigator.mediaDevices.getUserMedia({ audio: true })
        .then(stream => {
            const audioContext = new AudioContext();
            const analyser = audioContext.createAnalyser();
            const mic = audioContext.createMediaStreamSource(stream);
            mic.connect(analyser);
            analyser.fftSize = 256;
            const dataArray = new Uint8Array(analyser.frequencyBinCount);

            // Get the rectangle element
            const soundRectangle = document.getElementById("soundRectangle");

            // Check if soundRectangle exists
            if (!soundRectangle) {
                console.error("soundRectangle element not found.");
                return;
            }

            function draw() {
                requestAnimationFrame(draw);

                analyser.getByteFrequencyData(dataArray);
                let volume = dataArray.reduce((a, b) => a + b) / dataArray.length;
                let intensity = Math.min(volume / 2, 100); // Normalize the volume, limiting the max height
                        
                

                // Improved check for NaN and null
                if (intensity !== null && intensity !== undefined && !isNaN(intensity)) {
                    // Remove all height classes before adding the new one
                    soundRectangle.classList.remove("height-100", "height-150", "height-200", "height-250", "height-300", "height-350");
                    
                    // Dynamically calculate height based on intensity
                    let newHeight = 200 + intensity; // Minimum height is 100px
                    soundRectangle.style.height = `${newHeight}px`; // Apply the calculated height
                } else {
                    console.error("