<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Détection de Clignement avec MediaPipe</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-core"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bricolage+Grotesque:opsz,wght@12..96,700&display=swap" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bricolage+Grotesque:opsz,wght@12..96,300&display=swap" rel="stylesheet">

    <style>
        body {
            background-image: url('interface/lunettes.png'),url('interface/cercle.png'),url('interface/etoile.png'), url('interface/quadrillage.png') ; /* <-- path to your image */
            background-size: 14%, 17%, 130%, cover; /* This will make it cover the whole body */
            background-position: 17px 30px, top left, -150px -350px, center; /* Center the image */
            background-repeat: no-repeat; /* Avoid repeating the image */
            height: 100vh;
        }
    
        video { display: none; } 
        #status { 
            position: absolute;
            top: 15%;
            left: 65%; 
            font-family: "Bricolage Grotesque", sans-serif;
            font-optical-sizing: auto;
            font-weight: 300;
            font-style: normal;
            font-variation-settings:"wdth" 100;
            font-size: 24px;
            color: black;
        }

        #temps { 
            position: absolute;
            top: 10%; /* 10% from the top */
            left: 65%; /* 50% from the left */
            font-family: "Bricolage Grotesque", sans-serif;
            font-optical-sizing: auto;
            font-weight: 700;
            font-style: normal;
            font-variation-settings:"wdth" 100;
            font-size: 24px;
            color: black;
        }

        #imageContainer {
            position: relative;
            width: 100%; /* full width */
            height: 100vh; /* full height */
        }

        #sequenceImage1, #sequenceImage2 {
            position: absolute;
            top: 55%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 1000px;
            height: auto;
            transition: opacity 0.5s ease; /* Smooth fade */
        }
    </style>
</head>
<body>

    <video id="video" autoplay hidden></video>
    <div id="status"></div>
    <div id="temps">Il y a <span id="tempsValeur">250</span> millions d'années</div>

    <!-- Conteneur de l'image -->
    <div id="imageContainer">
        <img id="sequenceImage1" src="image/pangee1.png" alt="Séquence temporelle">
        <img id="sequenceImage2" src="image/pangee1.png" alt="Séquence temporelle" style="opacity: 0;">
    </div>

    <script>
        const videoElement = document.getElementById('video');
        const statusElement = document.getElementById('status');
        const tempsValeur = document.getElementById('tempsValeur');
        const sequenceImage1 = document.getElementById('sequenceImage1');
        const sequenceImage2 = document.getElementById('sequenceImage2');

        let activeImage = 1; // Start with sequenceImage1

        function changeImageCrossfade(nextImageSrc) {
            if (activeImage === 1) {
                sequenceImage2.src = nextImageSrc;
                sequenceImage2.style.opacity = 1; // Fade in image 2
                sequenceImage1.style.opacity = 0; // Fade out image 1
                activeImage = 2;
            } else {
                sequenceImage1.src = nextImageSrc;
                sequenceImage1.style.opacity = 1; // Fade in image 1
                sequenceImage2.style.opacity = 0; // Fade out image 2
                activeImage = 1;
            }
        }


        let blinkThreshold = 0.0015;
        let previousEyeOpen = 1;
        
        // Liste des images de la séquence
        const imageSequence = [
            "image/pangee1.png",
            "image/pangee2.png",
            "image/pangee3.png",
            "image/pangee4.png",
            "image/pangee5.png",
            "image/pangee6.png",
            "image/pangee7.png",
            "image/pangee8.png",
            "image/pangee9.png",
            "image/pangee10.png",
            "image/pangee11.png",
            "image/pangee12.png",
            "image/pangee13.png",
            "image/pangee14.png",
            "image/pangee15.png",
            "image/pangee16.png",
            "image/pangee17.png",
            "image/pangee18.png",
            "image/pangee19.png",
            "image/pangee20.png",
            "image/pangee21.png",
            "image/pangee22.png",
            "image/pangee23.png",
            "image/pangee24.png",
            "image/pangee25.png",
            "image/pangee26.png",];
            
            let currentImageIndex = 0;
        let startYear = 250;

        async function detectBlink() {
            const faceMesh = new FaceMesh({ locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}` });
            faceMesh.setOptions({ maxNumFaces: 1, refineLandmarks: true, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5 });

            faceMesh.onResults((results) => {
                if (results.multiFaceLandmarks.length > 0) {
                    const landmarks = results.multiFaceLandmarks[0];
                    const eyeTop = landmarks[159];
                    const eyeBottom = landmarks[145];
                    const eyeOpen = Math.abs(eyeTop.y - eyeBottom.y);

                    if (eyeOpen < blinkThreshold && previousEyeOpen >= blinkThreshold) {
                        if (currentImageIndex < imageSequence.length - 1) {
                            //sequenceImage.style.opacity = 0; // Fade out
                            setTimeout(() => {
                                currentImageIndex++;
                                changeImageCrossfade(imageSequence[currentImageIndex]);
                                if (currentImageIndex === imageSequence.length - 2) {
                                    tempsValeur.textContent = startYear - (currentImageIndex - 1) * 10 - 5;
                                } else {
                                    tempsValeur.textContent = startYear - currentImageIndex * 10;
                                }
                                sequenceImage.style.opacity = 1; // Fade in
                            }, 300);
                        }
                        statusElement.textContent = 'Clignement détecté !';
                    }

                    previousEyeOpen = eyeOpen;
                }
            });

            const camera = new Camera(videoElement, {
                onFrame: async () => {
                    await faceMesh.send({ image: videoElement });
                },
                width: 640,
                height: 480
            });
            camera.start();
        }

        detectBlink();
    </script>
</body>
</html>
